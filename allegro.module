<?php

/**
 * Implements hook_menu().
 */
function allegro_menu() {
  $items['admin/allegro'] = array(
    'title' => 'Allegro',
    'page callback' => 'drupal_get_form',
    'access arguments' => array('administer allegro'),
    'page arguments' => array('allegro_settings_form'),
    'file' => 'allegro.admin.inc',
  );
  $items['admin/allegro/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function allegro_permission() {
  return array(
    'administer allegro' => array(
      'title' => t('Administer Allegro'),
    ),
  );
}

/**
 * Connect to Allegro WebAPI and returns SoapClient object.
 *
 * @param  bool $login
 *   Log into the Soap service.
 * @param  bool $cache
 *   Whether to reset the internal allegro_client cache.
 *
 * @return mixed
 *   Returns Allegro client object when success, false otherwise.
 */
function allegro_client($login = TRUE, $reset = FALSE) {
  if (!$reset) {
    $allegro = &drupal_static(__FUNCTION__);
  }

  if (empty($allegro) || $allegro->logged != $login) {
    try {
      $allegro = new Allegro();

      $allegro->userLogin = variable_get('allegro_login');
      $allegro->userPassword = variable_get('allegro_password');
      $allegro->webapiKey = variable_get('allegro_webapikey');
      $allegro->countryCode = variable_get('allegro_country_code');

      if ($login) {
        $allegro->login();
      }
    }
    catch (SoapFault $e) {
      drupal_set_message($e->getMessage(), 'error');
      watchdog_exception('allegro', $e);
      unset($allegro);
    }
  }

  return !empty($allegro) ? $allegro : FALSE;
}

function allegro_test_connection($login, $password, $webapikey, $countryCode = 1) {
  try {
    Allegro::testConnection($login, $password, $webapikey, $countryCode);
    return TRUE;
  }
  catch (SoapFault $e) {
    drupal_set_message(t('Allegro: %fault', array('%fault' => $e->faultstring)), 'error');
    watchdog_exception('allegro', $e);
    return FALSE;
  }
}

/**
 * Convert object to array.
 *
 * @param object $object
 *
 * @return array
 */
function allegro_object2array($object) {
  if (!is_object($object) && !is_array($object)) {
    return $object;
  }
  if (is_object($object)) {
    $object = get_object_vars($object);
  }
  return array_map('allegro_object2array', $object);
}

/*
 * Unused.
 * Resizes images to pass Allegro validation.
 */
function allegro_resize_image($url) {
  $image = file_get_contents($url);

  // właśnie tutaj używamy Base64 ręcznie, ale nigdzie indziej!
  while (strlen(base64_encode($image)) > 200000) {
    $temp = imagecreatefromstring($image);
    $x = ceil(0.9 * imagesx($temp));
    $y = ceil(0.9 * imagesy($temp));

    $image = imagecreatetruecolor($x, $y);
    imagecopyresized($image, $temp, 0, 0, 0, 0, $x, $y, imagesx($temp), imagesy($temp));

    imagejpeg($image, 'temp.jpg', 75);
    $image = file_get_contents('temp.jpg');
    unlink('temp.jpg');
  }

  return $image;
}

/**
 * Check if it possible to connetc with Allegro WebAPI.
 *
 * @return bool
 *   True when connection was successful, false otherwise.
 */
function allegro_is_configured_correctly() {
  return allegro_client();
}
